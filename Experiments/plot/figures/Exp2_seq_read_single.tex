\makeatletter
\newcommand\resetstackedplots{
	\makeatletter
	\pgfplots@stacked@isfirstplottrue
	\makeatother
	\addplot [forget plot,draw=none] coordinates{({HandcodedCPP},1) ({inPlaceCPP},1) ({FlatBufCPP},1) ({ProtoBufCPP},1) ({BoostCPP},1) ({BsonCPP},1) ({MessagePackRust},1) ({BincodeRust},1) ({JsonRust},1) ({FlexBufRust},1) ({BsonRust},1) ({Json+GzipJava},1) ({JsonJava},1) ({BsonJava},1) ({DefaultJava},1) ({ProtoBufJava},1) ({ByteBufferJava},1) ({FlatBufJava},1) ({KryoJava},1)};
}
\makeatother


\begin{tikzpicture}
	\newcommand{\myaddplot}[8]{
	   \addplot[xshift=#2,draw=#5,line width=0.15pt, fill=#3, discard if single={#1}{#4}{#8}, postaction={pattern=#6,pattern color=#5}] 
	   table[ y=time, col sep=comma, x=baseline] {results/Exp2_read.dat};
	   \label{#4#1}
   };  

   \newcommand{\myaddplotnan}[9]{
	   \addplot[xshift=#2,draw=#9,line width=0.15pt, fill=#3, discard if single={#1}{#4}{#8}, %postaction={pattern=#6,pattern color=#5},
	   visualization depends on={value \thisrow{baseline} \as \xbaseline},
	   every node near coord/.append style={		  
		   check for zeronan/.code={
			   \pgfkeys{/pgf/fpu=true}
			   \showvalue{\xbaseline}{}{inPlaceCPP}{}{}{}{}{}{FlatBufJava}{}
			   \pgfkeys{/pgf/fpu=false}
		   },
		   check for zeronan,
	   }  
	   ] 
	   table[ y=time, col sep=comma, x=baseline] {results/Exp2_read.dat};	  
	   \label{#4#1}
   };  
   
   \newcommand{\myaddplots}[6]{	   
	\addplot[xshift=#2,draw=#5,line width=0.15pt, fill=#3, discard if single={#1}{#4}{#6},
		forget plot,
		nodes near coords custom=1,
		nodes near coords={\pgfmathprintnumber[precision=1]{\pgfplotspointmeta}},
		every node near coord/.append style={
			black,			
			xshift=-7pt,
			anchor=west
		}
	] 
	table[ y=time, col sep=comma, x=baseline] {results/Exp2_read.dat};	
   };   
   
   \newcommand{\addDiagramExpOne}[9]{	
	\nextgroupplot[
		width=#4,		
		ytick=#5,
		y axis line style={opacity=#6},
		#7,
		axis y line*=#8,
		%xlabel=#9,				
		]
		\resetstackedplots	
		\myaddplot{True}{-4}{#2}{IO}{#2}{none}{I/O Time(taskset True)}{#1};
  		\myaddplotnan{True}{-4}{#2!40}{CPU}{#2!40}{north east lines}{CPU Time(taskset True)}{#1}{#2};
		\myaddplots{True}{-4}{white}{Total}{none}{#1};
	    \resetstackedplots	 
		\myaddplot{False}{4}{#3}{IO}{#3}{none}{I/O Time(taskset False)}{#1};  
	    \myaddplotnan{False}{4}{#3!40}{CPU}{#3!40}{north west lines}{CPU Time(taskset False)}{#1}{#3};
		\myaddplots{False}{4}{white}{Total}{none}{#1};    
   };     

  \pgfplotsset{
	   discard if single/.style n args={3}{
		   x filter/.code={
			   \edef\tempa{\thisrow{taskset}}
			   \edef\tempb{#1}
			   \ifx\tempa\tempb
					\edef\tempe{\thisrow{execution}}
					\edef\tempf{#2}
					\ifx\tempe\tempf	
					   	%
						\edef\tempg{\thisrow{language}}
						\edef\temph{#3}
						\ifx\tempg\temph	
							%
							\edef\tempi{\thisrow{platform}}
							\edef\tempj{Single}
								\ifx\tempi\tempj	
									%
									\edef\tempk{\thisrow{nrow}}
									\edef\templ{5000000}
									\ifx\tempk\templ
										%
										\edef\tempm{\thisrow{seq_rand}}
										\edef\tempn{Sequential}
										\ifx\tempm\tempn
										\else
										\def\pgfmathresult{inf}
							    		\fi 
										%	
									\else
									\def\pgfmathresult{inf}
							    	\fi  	
									%											   
							    \else
							    \def\pgfmathresult{inf}
							    \fi      
							%
						\else
						\def\pgfmathresult{inf}
						\fi      
						%
					\else
					\def\pgfmathresult{inf}
					\fi      
			   \else
			\def\pgfmathresult{inf}
			\fi			
		   }
	   },
	   nodes near coords custom/.style={
		large value/.style={                    
			rotate=90,
			anchor=east,			
		},
		small value/.style={
			rotate=90,
			anchor=east,
		},
		every node near coord/.style={
		  font=\scriptsize,
		  inner sep=0.5mm,
		  /pgf/number format/1000 sep={},
		  check for zero/.code={%
			\pgfkeys{/pgf/fpu=true}
			\pgfmathparse{\pgfplotspointmeta-1}
			\pgfmathfloatifflags{\pgfmathresult}{0}{
				\pgfkeys{/tikz/coordinate}
			}{
				\begingroup                      
					\pgfkeys{/pgf/fpu}%
					\pgfmathparse{\pgfplotspointmeta<#1}%
					\global\let\result=\pgfmathresult
				\endgroup
				\pgfmathfloatcreate{1}{1.0}{0}%
				\let\ONE=\pgfmathresult
				\ifx\result\ONE
					% AH : our condition 'y < #1' is met.
					\pgfkeysalso{/pgfplots/small value}%
				\else
					% ok, proceed as usual.
					\pgfkeysalso{/pgfplots/large value}%
				\fi
			}
			\pgfkeys{/pgf/fpu=false}
		  },
		  check for zero,
		},
	},   
   };
   %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
   \begin{groupplot}[
		group style={
			group size=3 by 1,
			xlabels at=edge bottom,
			ylabels at=edge left,
			horizontal sep=0pt,
			vertical sep=0pt,
			/pgf/bar width=8pt
		},			
		%every major tick/.append style={thick,major tick length=3.5pt, gray},
		axis line style={gray},
		ybar stacked,        
		ymode=log,
		ymin=8,
		ymax=10000,
		scaled y ticks=false,		  
		enlarge y limits={0.2,upper},		
		%enlarge x limits = {abs=1},
		ylabel={Execution Time[s]},		   
		ytick align=inside,
		xtick align=outside,			
		xtick pos=left,
		ytick pos=left,
		yticklabel style = {font=\scriptsize},
		ylabel style = {font=\scriptsize, yshift=-12pt},
		xticklabel style = {font=\scriptsize},
		x label style={yshift=-20pt},
		xtick=data,
		height=0.6\columnwidth,  
		%bar width=10pt,
		%width=0.33\textwidth, 				
		% ymajorgrids=true,
		% grid style=dotted,   
		% %x axis line style={opacity=0},	
		% %y axis line style={opacity=0},	
		% minor grid style={gray!50},  
		symbolic x coords={ HandcodedCPP, inPlaceCPP, FlatBufCPP, ProtoBufCPP, BoostCPP, BsonCPP, MessagePackRust, BincodeRust, JsonRust, FlexBufRust, BsonRust, Json+GzipJava, JsonJava, BsonJava, DefaultJava, ProtoBufJava, ByteBufferJava, FlatBufJava, KryoJava},		   
		xticklabels={ HandCoded,, FlatBuf,, Boost,, MessagePack,, Json,, Bson,, Json,, Default,, Byte Buffer,, Kryo},  
		%-----------------		   
		extra x ticks={inPlaceCPP,ProtoBufCPP,BsonCPP,BincodeRust,FlexBufRust,Json+GzipJava,BsonJava, ProtoBufJava,FlatBufJava},
		extra x tick labels={inPlace,ProtoBuf,Bson,Bincode,FlexBuf,Json+Gzip,Bson,ProtoBuf,FlatBuf},
		every extra x tick/.style={major tick length=15pt, xtick align=outside},
		%----------------		   
		point meta=rawy,            
		nodes near coords={\pgfmathprintnumber[precision=0]{\pgfplotspointmeta}},
		nodes near coords custom={1}, 
		legend image code/.code={\draw [#1] (0cm,-0.1cm) rectangle (0.20cm,0.20cm); },
		xticklabel style={name=T\ticknum}			
]
\addDiagramExpOne{CPP}{tugb}{color7}{0.4\textwidth}{{10,100,1000,10000,100000}}{1}{{enlarge x limits=0.12,}}{left}{C++};		

\node [draw=none,inner sep=0, font=\scriptsize, anchor=west](leg1) at (rel axis cs: 0.04,0.85) {\shortstack[l]{
		\ref{CPUTrue} CPU Time(taskset True) \\ \\
		\ref{IOTrue} I/O Time(taskset True) 			
}};
\addDiagramExpOne{Rust}{tugb}{color7}{0.4\textwidth}{\empty}{0}{{enlarge x limits=0.24,}}{left}{Rust};
\node [draw=none,inner sep=0, font=\scriptsize, anchor=west](leg1) at (rel axis cs: 0.04,0.85) {\shortstack[l]{
		\ref{CPUFalse} CPU Time(taskset False) \\ \\
		\ref{IOFalse} I/O Time(taskset False) 			
}};
\addDiagramExpOne{Java}{tugb}{color7}{0.48\textwidth}{\empty}{1}{{enlarge x limits=0.12,}}{right}{Java};
		
\end{groupplot}

\begin{scope}[decoration=brace]
	\pgfdecorationsegmentamplitude=5pt
	\draw[decorate] ($(T2.south east)+(-5pt,0)$) -- ($(T0.south west)+(-20pt,0)$) node[midway,below=\pgfdecorationsegmentamplitude] {\footnotesize{C++}};
	\draw[decorate] ($(T4.south east)+(15pt,0)$) -- ($(T3.south west)+(-25pt,0)$) node[midway,below=\pgfdecorationsegmentamplitude] {\footnotesize{Rust}};
	\draw[decorate] ($(T8.south east)+(15pt,0)$) -- ($(T5.south west)+(-0pt,0)$) node[midway,below=\pgfdecorationsegmentamplitude] {\footnotesize{Java}};	
  \end{scope}
\end{tikzpicture}